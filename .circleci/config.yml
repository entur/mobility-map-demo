# For help and tutorials, visit https://circleci.com/docs/
# For internal documentation visit https://enturas.atlassian.net/wiki/spaces/ESP/pages/580026490/CircleCI
version: 2.1

orbs:
  node: circleci/node@1.1.6

references:
  workspace_root: &workspace_root
    ~/project
  attach_workspace: &attach_workspace
    attach_workspace:
      at: *workspace_root

aliases:
- &authenticate_dev
  name: GCP Authenticate dev
  command: |
    echo 'export GCLOUD_SERVICE_KEY="$SERVICE_ACCOUNT_DEV"' >> $BASH_ENV
    /tools/gcp_authenticate.sh
- &firebase_deploy_dev
  name: Firebase deploy
  command: npx firebase -P dev deploy

jobs:
  build:
    executor:
      name: node/default
      tag: '10.13'
    steps:
    - *attach_workspace
    - checkout
    - node/with-cache:
        cache-key: package-lock.json
        cache-version: v1
        steps:
          - run:
              name: Install dependencies
              command: npm install
    - run:
        name: "Run tests"
        command: npm run test
    - run:
        name: "Create production build"
        command: npm run build
    - persist_to_workspace:
        root: *workspace_root
        paths:
        - .
  deploy-dev:
    docker:
    - image: eu.gcr.io/entur-system-1287/circleci-toolbox-image-java11
      auth:
        username: _json_key
        password: $DOCKER_PASSWORD
    steps:
    - *attach_workspace
    - run: *authenticate_dev
    - run: *firebase_deploy_dev

workflows:
  "Build Pipeline":
    jobs:
    - build
    - deploy-dev:
        context: global
        filters:
          branches:
            only: master
        requires:
          - build
